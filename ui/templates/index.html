<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reference Assistant</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <script>
    // Initialize tooltips, dropdowns, and collapse when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Initialize all dropdowns
        var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
        dropdownElementList.map(function (dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl);
        });
        
        // Toggle chevron icon on collapse
        var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
        collapseElements.forEach(function(element) {
            element.addEventListener('click', function() {
                var icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('bi-chevron-down');
                    icon.classList.toggle('bi-chevron-up');
                }
            });
        });
    });
    
    // Copy to clipboard function
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show a temporary tooltip or alert to indicate success
            alert('Citation copied to clipboard!');
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            alert('Failed to copy to clipboard. Please try again.');
        });
    }
    </script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-3">ZiReference Assistant â€” Web UI</h1>
      
      <!-- Main Search Form -->
      <form action="{{ url_for('index') }}" method="post" class="mb-4">
        {{ form.csrf_token }}
        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <label for="query" class="form-label">Search Query</label>
            {{ form.query(class="form-control form-control-lg", placeholder="Search by title, author, or keywords") }}
          </div>
          <div class="col-md-2">
            <label for="stype" class="form-label">Search Type</label>
            {{ form.stype(class="form-select") }}
          </div>
          <div class="col-md-2">
            <label for="style" class="form-label">Citation Style</label>
            {{ form.style(class="form-select") }}
          </div>
        </div>
        
        <!-- Advanced Search Toggle -->
        <div class="mb-3">
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSearch" aria-expanded="false" aria-controls="advancedSearch">
            <i class="bi bi-funnel"></i> Advanced Search
          </button>
        </div>
        
        <!-- Advanced Search Options -->
        <div class="collapse mb-3" id="advancedSearch">
          <div class="card card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="year_from" class="form-label">Year Range</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="year_from" name="year_from" placeholder="From" min="1900" max="{{ current_year }}">
                  <span class="input-group-text">to</span>
                  <input type="number" class="form-control" id="year_to" name="year_to" placeholder="To" min="1900" max="{{ current_year }}">
                </div>
              </div>
              <div class="col-md-4">
                <label for="document_type" class="form-label">Document Type</label>
                <select class="form-select" id="document_type" name="document_type">
                  <option value="" selected>All Types</option>
                  <option value="article">Journal Article</option>
                  <option value="book">Book</option>
                  <option value="conference">Conference Paper</option>
                  <option value="thesis">Thesis</option>
                  <option value="report">Report</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="language" class="form-label">Language</label>
                <select class="form-select" id="language" name="language">
                  <option value="" selected>Any Language</option>
                  <option value="en">English</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="es">Spanish</option>
                  <option value="zh">Chinese</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Search
          </button>
        </div>
      </form>

    <hr>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">My References</h2>
      <div>
        <a href="/manual" class="btn btn-outline-primary btn-sm me-2">
          <i class="bi bi-plus-circle"></i> Add Manually
        </a>
        {% if refs %}
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-download"></i> Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('export', format='bibtex') }}">BibTeX (.bib)</a></li>
              <li><a class="dropdown-item" href="{{ url_for('export', format='ris') }}">RIS (.ris)</a></li>
              <li><a class="dropdown-item" href="{{ url_for('export', format='csv') }}">CSV (.csv)</a></li>
              <li><a class="dropdown-item" href="{{ url_for('export', format='json') }}">JSON (.json)</a></li>
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
    
    {% if refs %}
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#referencesCollapse" role="button" aria-expanded="true" aria-controls="referencesCollapse" style="cursor: pointer;">
          <h5 class="mb-0">My References <span class="badge bg-primary rounded-pill">{{ refs|length }}</span></h5>
          <i class="bi bi-chevron-down"></i>
        </div>
        <div class="collapse show" id="referencesCollapse">
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
        {% for r in refs %}
          <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ r.title }}</h6>
              <small class="text-muted">{{ r.year }}</small>
            </div>
            <p class="mb-1">
              {% if r.authors %}{{ r.authors|join('; ') }}. {% endif %}
              {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
              {% if r.volume %}, {{ r.volume }}{% endif %}
              {% if r.issue %}({{ r.issue }}){% endif %}
              {% if r.pages %}, pp. {{ r.pages }}{% endif %}
            </p>
            <div class="btn-group btn-group-sm">
              {% if r.doi %}
                <a href="https://doi.org/{{ r.doi }}" target="_blank" class="btn btn-outline-secondary btn-sm" title="View" data-bs-toggle="tooltip">
                  <i class="bi bi-box-arrow-up-right"></i> View
                </a>
              {% endif %}
              <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#citationModal{{ loop.index }}" title="Cite" data-bs-toggle="tooltip">
                <i class="bi bi-quote"></i> Cite
              </button>
              <div class="btn-group btn-group-sm" data-bs-toggle="tooltip" title="Export">
                <button type="button" class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-download"></i> Export
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{{ url_for('export', format='bibtex', idx=loop.index0) }}">BibTeX (.bib)</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('export', format='ris', idx=loop.index0) }}">RIS (.ris)</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('export', format='json', idx=loop.index0) }}">JSON (.json)</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('export', format='csv', idx=loop.index0) }}">CSV (.csv)</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{{ url_for('export_word', idx=loop.index0) }}">Word (.docx)</a></li>
                </ul>
              </div>
              <a href="{{ url_for('remove', idx=loop.index0) }}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this reference?')" title="Delete" data-bs-toggle="tooltip">
                <i class="bi bi-trash"></i>
              </a>
            </div>
            
            <!-- Citation Modal -->
            <div class="modal fade" id="citationModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Citation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="citationTabs{{ loop.index }}" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="apa-tab-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#apa-{{ loop.index }}" type="button" role="tab" aria-controls="apa-{{ loop.index }}" aria-selected="true">APA</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mla-tab-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#mla-{{ loop.index }}" type="button" role="tab" aria-controls="mla-{{ loop.index }}">MLA</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chicago-tab-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#chicago-{{ loop.index }}" type="button" role="tab" aria-controls="chicago-{{ loop.index }}">Chicago</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ieee-tab-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#ieee-{{ loop.index }}" type="button" role="tab" aria-controls="ieee-{{ loop.index }}">IEEE</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vancouver-tab-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#vancouver-{{ loop.index }}" type="button" role="tab" aria-controls="vancouver-{{ loop.index }}">Vancouver</button>
                      </li>
                    </ul>
                    
                    <div class="tab-content" id="citationTabsContent{{ loop.index }}">
                      <!-- APA Style -->
                      <div class="tab-pane fade show active" id="apa-{{ loop.index }}" role="tabpanel" aria-labelledby="apa-tab-{{ loop.index }}">
                        <p class="border p-3 bg-light" id="citation-apa-{{ loop.index }}">
                          {% if r.authors %}
                            {% if r.authors is string %}
                              {{ r.authors }}
                            {% else %}
                              {{ r.authors|join(', ') }}
                            {% endif %}
                            {% if r.year %} ({{ r.year }}){% endif %}.
                          {% endif %}
                          {% if r.title %}<strong>{{ r.title|title }}</strong>.{% endif %}
                          {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
                          {% if r.volume %}, {{ r.volume }}{% endif %}
                          {% if r.issue %}({{ r.issue }}){% endif %}
                          {% if r.pages %}, {{ r.pages }}.{% endif %}
                          {% if r.doi %}
                            <br>https://doi.org/{{ r.doi }}
                          {% endif %}
                        </p>
                      </div>
                      
                      <!-- MLA Style -->
                      <div class="tab-pane fade" id="mla-{{ loop.index }}" role="tabpanel" aria-labelledby="mla-tab-{{ loop.index }}">
                        <p class="border p-3 bg-light" id="citation-mla-{{ loop.index }}">
                          {% if r.authors %}
                            {% if r.authors is string %}
                              {{ r.authors }}
                            {% else %}
                              {{ r.authors|join(', ') }}
                            {% endif %}
                            {% if r.year %}. "{{ r.title|title }}"{% endif %}
                          {% endif %}
                          {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
                          {% if r.volume %}, vol. {{ r.volume }}{% endif %}
                          {% if r.issue %}, no. {{ r.issue }}{% endif %}
                          {% if r.year %} ({{ r.year }}){% endif %}
                          {% if r.pages %}, pp. {{ r.pages }}.{% endif %}
                          {% if r.doi %}
                            <br>https://doi.org/{{ r.doi }}
                          {% endif %}
                        </p>
                      </div>
                      
                      <!-- Chicago Style -->
                      <div class="tab-pane fade" id="chicago-{{ loop.index }}" role="tabpanel" aria-labelledby="chicago-tab-{{ loop.index }}">
                        <p class="border p-3 bg-light" id="citation-chicago-{{ loop.index }}">
                          {% if r.authors %}
                            {% if r.authors is string %}
                              {{ r.authors }}
                            {% else %}
                              {{ r.authors|join(', ') }}
                            {% endif %}
                            {% if r.year %} ({{ r.year }}){% endif %}. 
                          {% endif %}
                          "{{ r.title|title }}."
                          {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
                          {% if r.volume %}, {{ r.volume }}{% endif %}
                          {% if r.issue %}, no. {{ r.issue }}{% endif %}
                          {% if r.year %} ({{ r.year }}){% endif %}
                          {% if r.pages %}: {{ r.pages }}.{% else %}.{% endif %}
                          {% if r.doi %}
                            <br>https://doi.org/{{ r.doi }}
                          {% endif %}
                        </p>
                      </div>
                      
                      <!-- IEEE Style -->
                      <div class="tab-pane fade" id="ieee-{{ loop.index }}" role="tabpanel" aria-labelledby="ieee-tab-{{ loop.index }}">
                        <p class="border p-3 bg-light" id="citation-ieee-{{ loop.index }}">
                          {% if r.authors %}
                            {% if r.authors is string %}
                              {{ r.authors }}
                            {% else %}
                              {{ r.authors|join(', ') }}
                            {% endif %},
                          {% endif %}
                          "{{ r.title }},"
                          {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
                          {% if r.volume %}, vol. {{ r.volume }}{% endif %}
                          {% if r.issue %}, no. {{ r.issue }}{% endif %}
                          {% if r.pages %}, pp. {{ r.pages }}{% endif %}
                          {% if r.year %}, {{ r.year }}.{% endif %}
                          {% if r.doi %}
                            <br>doi: {{ r.doi }}
                          {% endif %}
                        </p>
                      </div>
                      
                      <!-- Vancouver Style -->
                      <div class="tab-pane fade" id="vancouver-{{ loop.index }}" role="tabpanel" aria-labelledby="vancouver-tab-{{ loop.index }}">
                        <p class="border p-3 bg-light" id="citation-vancouver-{{ loop.index }}">
                          {% if r.authors %}
                            {% if r.authors is string %}
                              {{ r.authors }}
                            {% else %}
                              {{ r.authors|join(' ') }}
                            {% endif %}
                            .
                          {% endif %}
                          {{ r.title|title }}.
                          {% if r.journal %}{{ r.journal }}.{% endif %}
                          {% if r.year %} {{ r.year }};{% endif %}
                          {% if r.volume %}{{ r.volume }}{% endif %}
                          {% if r.issue %}({{ r.issue }}){% endif %}
                          {% if r.pages %}:{{ r.pages }}.{% else %}.{% endif %}
                          {% if r.doi %}
                            <br>DOI: {{ r.doi }}
                          {% endif %}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <div class="btn-group">
                      <button type="button" class="btn btn-primary" onclick="copyToClipboard(document.querySelector('#citation-apa-{{ loop.index }}').textContent)">
                        <i class="bi bi-clipboard"></i> Copy
                      </button>
                      <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard(document.querySelector('#citation-apa-{{ loop.index }}').textContent); return false;">APA</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard(document.querySelector('#citation-mla-{{ loop.index }}').textContent); return false;">MLA</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard(document.querySelector('#citation-chicago-{{ loop.index }}').textContent); return false;">Chicago</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard(document.querySelector('#citation-ieee-{{ loop.index }}').textContent); return false;">IEEE</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard(document.querySelector('#citation-vancouver-{{ loop.index }}').textContent); return false;">Vancouver</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted">
          Showing {{ refs|length }} reference{% if refs|length != 1 %}s{% endif %}
        </div>
        <a href="{{ url_for('bibliography') }}" class="btn btn-outline-primary">
          <i class="bi bi-journal-text"></i> Generate Bibliography
        </a>
      </div>
    {% else %}
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">My References</h5>
        </div>
        <div class="card-body text-center py-5 bg-light">
          <i class="bi bi-journal-text" style="font-size: 2rem;"></i>
          <h4 class="mt-3">No references yet</h4>
          <p class="text-muted">Start by adding references using the search or manual entry</p>
          <a href="/manual" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Your First Reference
          </a>
        </div>
      </div>
    {% endif %}
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script>
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
          // Show a success message
          const alert = document.createElement('div');
          alert.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
          alert.role = 'alert';
          alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>Citation copied to clipboard!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          document.body.appendChild(alert);
          
          // Remove the alert after 3 seconds
          setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }, 3000);
        });
      }
      
      // Initialize tooltips
      document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
  </body>
</html>
