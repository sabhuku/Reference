<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Reference Assistant</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>

  <script>
    // Initialize tooltips, dropdowns, and collapse when the document is ready
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize all tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Initialize all dropdowns
      var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
      dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl);
      });

      // Toggle chevron icon on collapse
      var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
      collapseElements.forEach(function (element) {
        element.addEventListener('click', function () {
          var icon = this.querySelector('i');
          if (icon) {
            icon.classList.toggle('bi-chevron-down');
            icon.classList.toggle('bi-chevron-up');
          }
        });
      });
    });

    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function () {
        // Show a temporary tooltip or alert to indicate success
        alert('Citation copied to clipboard!');
      }).catch(function (err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy to clipboard. Please try again.');
      });
    }
  </script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>
  <!-- Top Taskbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <span class="navbar-brand">Welcome to My Reference</span>
      <div class="navbar-nav ms-auto flex-row align-items-center">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('profile') }}" class="navbar-text me-3 text-white text-decoration-none">
          <i class="bi bi-person-circle"></i> {{ current_user.username }}
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-sm me-2">Login</a>
        <a href="{{ url_for('register') }}" class="btn btn-light btn-sm">Sign Up</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Sub-Navigation Bar -->
  <div class="bg-light border-bottom mb-4">
    <div class="container py-2">
      <div class="d-flex gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-house-door"></i> Home
        </a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('bibliographies') }}" class="btn btn-outline-primary btn-sm">
          My Bibliographies
        </a>
        {% endif %}
        <a href="{{ url_for('import_file') }}" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip"
          title="Upload a file to check its Harvard compliance instantly.">
          <i class="bi bi-upload"></i> Import & Check
        </a>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}



    <!-- Main Search Form -->
    <form action="{{ url_for('index') }}" method="post" class="mb-4">
      {{ form.csrf_token }}
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <label for="query" class="form-label">Search Query</label>
          {{ form.query(class="form-control form-control-lg", placeholder="Search by title, author, or keywords") }}
        </div>
        <div class="col-md-2">
          <label for="stype" class="form-label">Search Type</label>
          {{ form.stype(class="form-select") }}
        </div>
        <div class="col-md-2">
          <label for="style" class="form-label">Citation Style</label>
          {{ form.style(class="form-select") }}
        </div>
      </div>

      <!-- Advanced Search Toggle -->
      <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
          data-bs-target="#advancedSearch" aria-expanded="false" aria-controls="advancedSearch">
          <i class="bi bi-funnel"></i> Advanced Search
        </button>
      </div>

      <!-- Advanced Search Options -->
      <div class="collapse mb-3" id="advancedSearch">
        <div class="card card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="year_from" class="form-label">Year Range</label>
              <div class="input-group">
                <input type="number" class="form-control" id="year_from" name="year_from" placeholder="From" min="1900"
                  max="{{ current_year }}">
                <span class="input-group-text">to</span>
                <input type="number" class="form-control" id="year_to" name="year_to" placeholder="To" min="1900"
                  max="{{ current_year }}">
              </div>
            </div>
            <div class="col-md-4">
              <label for="document_type" class="form-label">Document Type</label>
              <select class="form-select" id="document_type" name="document_type">
                <option value="" selected>All Types</option>
                <option value="article">Journal Article</option>
                <option value="book">Book</option>
                <option value="conference">Conference Paper</option>
                <option value="thesis">Thesis</option>
                <option value="report">Report</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="language" class="form-label">Language</label>
              <select class="form-select" id="language" name="language">
                <option value="" selected>Any Language</option>
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="es">Spanish</option>
                <option value="zh">Chinese</option>
              </select>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <div class="form-check">
                {{ form.open_access(class="form-check-input") }}
                <label class="form-check-label" for="open_access">
                  Open Access Only
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                {{ form.include_abstract(class="form-check-input") }}
                <label class="form-check-label" for="include_abstract">
                  Include Abstract
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
    </form>

    <hr>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">My References</h2>
      <div>
        <a href="/manual" class="btn btn-outline-primary btn-sm me-2">
          <i class="bi bi-plus-circle"></i> Add Manually
        </a>
        {% if refs %}
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-download"></i> Export
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('export', format='bibtex') }}">BibTeX (.bib)</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export', format='ris') }}">RIS (.ris)</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export', format='csv') }}">CSV (.csv)</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export', format='json') }}">JSON (.json)</a></li>
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    {% if refs %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse"
        href="#referencesCollapse" role="button" aria-expanded="true" aria-controls="referencesCollapse"
        style="cursor: pointer;">
        <h5 class="mb-0">My References <span class="badge bg-primary rounded-pill">{{ total_refs }}</span></h5>
        <i class="bi bi-chevron-down"></i>
      </div>
      <div class="collapse show" id="referencesCollapse">
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            {% for paginated_ref in refs %}
            {% set r = paginated_ref.data %}
            {% set idx = paginated_ref.original_index %}
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ r.title }}</h6>
                <small class="text-muted">{{ r.year }}</small>
              </div>
              <p class="mb-1">
                {% if r.authors %}{{ r.authors|join('; ') }}. {% endif %}
                {% if r.journal %}<em>{{ r.journal }}</em>{% endif %}
                {% if r.volume %}, {{ r.volume }}{% endif %}
                {% if r.issue %}({{ r.issue }}){% endif %}
                {% if r.pages %}, pp. {{ r.pages }}{% endif %}
              </p>
              <div class="btn-group btn-group-sm">
                {% if r.doi %}
                <a href="https://doi.org/{{ r.doi }}" target="_blank" class="btn btn-outline-secondary btn-sm"
                  title="View" data-bs-toggle="tooltip">
                  <i class="bi bi-box-arrow-up-right"></i> View
                </a>
                {% endif %}
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                  data-bs-target="#citationModal{{ idx }}" title="Cite" data-bs-toggle="tooltip">
                  <i class="bi bi-quote"></i> Cite
                </button>
                <div class="btn-group btn-group-sm" data-bs-toggle="tooltip" title="Export">
                  <button type="button" class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="bi bi-download"></i> Export
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('export', format='bibtex', idx=idx) }}">BibTeX
                        (.bib)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('export', format='ris', idx=idx) }}">RIS
                        (.ris)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('export', format='json', idx=idx) }}">JSON
                        (.json)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('export', format='csv', idx=idx) }}">CSV
                        (.csv)</a></li>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="{{ url_for('export_word', idx=idx) }}">Word (.docx)</a>
                    </li>
                  </ul>
                </div>
                <a href="{{ url_for('remove', idx=idx) }}" class="btn btn-outline-danger btn-sm"
                  onclick="return confirm('Are you sure you want to delete this reference?')" title="Delete"
                  data-bs-toggle="tooltip">
                  <i class="bi bi-trash"></i>
                </a>
              </div>

              <!-- Citation Modal -->
              <div class="modal fade" id="citationModal{{ idx }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Citation</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="harvard-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#harvard-{{ idx }}" type="button" role="tab" aria-controls="harvard-{{ idx }}"
                          aria-selected="true">Harvard</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="apa-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#apa-{{ idx }}" type="button" role="tab" aria-controls="apa-{{ idx }}"
                          aria-selected="false">APA</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mla-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#mla-{{ idx }}" type="button" role="tab"
                          aria-controls="mla-{{ idx }}">MLA</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chicago-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#chicago-{{ idx }}" type="button" role="tab"
                          aria-controls="chicago-{{ idx }}">Chicago</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ieee-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#ieee-{{ idx }}" type="button" role="tab"
                          aria-controls="ieee-{{ idx }}">IEEE</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vancouver-tab-{{ idx }}" data-bs-toggle="tab"
                          data-bs-target="#vancouver-{{ idx }}" type="button" role="tab"
                          aria-controls="vancouver-{{ idx }}">Vancouver</button>
                      </li>
                      </ul>

                      <div class="tab-content" id="citationTabsContent{{ idx }}">
                        <!-- Harvard Style -->
                        <div class="tab-pane fade show active" id="harvard-{{ idx }}" role="tabpanel"
                          aria-labelledby="harvard-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-harvard-{{ idx }}">
                            {{ r | reference_entry('harvard') }}
                          </p>
                        </div>

                        <!-- APA Style -->
                        <div class="tab-pane fade" id="apa-{{ idx }}" role="tabpanel"
                          aria-labelledby="apa-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-apa-{{ idx }}">
                            {{ r | reference_entry('apa') }}
                          </p>
                        </div>

                        <!-- MLA Style -->
                        <div class="tab-pane fade" id="mla-{{ idx }}" role="tabpanel"
                          aria-labelledby="mla-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-mla-{{ idx }}">
                            {{ r | reference_entry('mla') }}
                          </p>
                        </div>

                        <!-- Chicago Style -->
                        <div class="tab-pane fade" id="chicago-{{ idx }}" role="tabpanel"
                          aria-labelledby="chicago-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-chicago-{{ idx }}">
                            {{ r | reference_entry('chicago') }}
                          </p>
                        </div>

                        <!-- IEEE Style -->
                        <div class="tab-pane fade" id="ieee-{{ idx }}" role="tabpanel"
                          aria-labelledby="ieee-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-ieee-{{ idx }}">
                            {{ r | reference_entry('ieee', idx + 1) }}
                          </p>
                        </div>

                        <!-- Vancouver Style -->
                        <div class="tab-pane fade" id="vancouver-{{ idx }}" role="tabpanel"
                          aria-labelledby="vancouver-tab-{{ idx }}">
                          <p class="border p-3 bg-light" id="citation-vancouver-{{ idx }}">
                            {{ r | reference_entry('vancouver', idx + 1) }}
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <div class="btn-group">
                        <button type="button" class="btn btn-primary"
                          onclick="copyToClipboard(document.querySelector('.tab-pane.show.active p').textContent)">
                          <i class="bi bi-clipboard"></i> Copy
                        </button>
                        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                          data-bs-toggle="dropdown" aria-expanded="false">
                          <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-harvard-{{ idx }}').textContent); return false;">Harvard</a>
                          </li>
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-apa-{{ idx }}').textContent); return false;">APA</a>
                          </li>
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-mla-{{ idx }}').textContent); return false;">MLA</a>
                          </li>
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-chicago-{{ idx }}').textContent); return false;">Chicago</a>
                          </li>
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-ieee-{{ idx }}').textContent); return false;">IEEE</a>
                          </li>
                          <li><a class="dropdown-item" href="#"
                              onclick="copyToClipboard(document.querySelector('#citation-vancouver-{{ idx }}').textContent); return false;">Vancouver</a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% if total_pages > 1 %}
        <div class="card-footer bg-white border-top-0 py-3">
          <nav aria-label="Reference pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=page-1) }}" tabindex="-1">Previous</a>
              </li>

              {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
              </li>
              {% endfor %}

              <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=page+1) }}">Next</a>
              </li>
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <div class="text-muted">
        Showing {{ refs|length }} of {{ total_refs }} reference{% if total_refs != 1 %}s{% endif %}
      </div>
      <a href="{{ url_for('bibliography') }}" class="btn btn-outline-primary">
        <i class="bi bi-journal-text"></i> Generate Bibliography
      </a>
    </div>
    {% else %}
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">My References</h5>
      </div>
      <div class="card-body text-center py-5 bg-light">
        <i class="bi bi-journal-text" style="font-size: 2rem;"></i>
        <h4 class="mt-3">No references yet</h4>
        <p class="text-muted">Start by adding references using the search or manual entry</p>
        <a href="/manual" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add Your First Reference
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <script>
      // Auto-dismiss alert messages after 5 seconds
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
          let alerts = document.querySelectorAll('.alert-dismissible');
          alerts.forEach(function (alert) {
            let bootstrapAlert = new bootstrap.Alert(alert);
            bootstrapAlert.close();
          });
        }, 5000);
      });

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function () {
          // Show a success message
          const alert = document.createElement('div');
          alert.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
          alert.role = 'alert';
          alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>Citation copied to clipboard!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          document.body.appendChild(alert);

          // Remove the alert after 3 seconds
          setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }, 3000);
        });
      }

      // Initialize tooltips
      document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
</body>

</html>