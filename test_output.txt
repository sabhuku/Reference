============================= test session starts =============================
platform win32 -- Python 3.12.7, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\stenf\Documents\referencing_backup
configfile: pytest.ini
plugins: anyio-4.2.0, asyncio-1.3.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

tests\test_analytics_logging.py F                                        [100%]

================================== FAILURES ===================================
______________ TestAnalyticsLogging.test_log_edit_and_compliace _______________

self = <referencing_backup.tests.test_analytics_logging.TestAnalyticsLogging object at 0x000001684629A930>
client = <FlaskClient <Flask 'ui.app'>>

    def test_log_edit_and_compliace(self, client):
        # 1. Clear or record start size of log file
        start_size = 0
        if ANALYTICS_FILE.exists():
            start_size = ANALYTICS_FILE.stat().st_size
    
        print(f"Log file: {ANALYTICS_FILE}")
    
        # 2. Inject a reference
        with client.session_transaction() as sess:
            sess['refs'] = [{
                'source': 'manual',
                'pub_type': 'book',
                'title': 'Original Title',
                'authors': ['Author, A.'],
                'year': '2023',
                'publisher': 'Pub',
                'location': 'Loc'
            }]
    
        # 3. Perform Edit
        rv = client.post('/edit/0', data={
            'title': 'Edited Title',
            'authors': 'Author, A.',
            'year': '2023',
            'pub_type': 'book',
            'publisher': 'Pub',
            'journal': '',
            'volume': '',
            'issue': '',
            'pages': '',
            'doi': ''
        }, follow_redirects=True)
        assert rv.status_code == 200
    
        # 4. Perform Compliance Check
        # /compliance leads to a render, we just need to ensure it runs without error
        rv = client.get('/compliance?origin=bibliography')
        assert rv.status_code == 200
    
        # 5. Verify Log File Content
        assert ANALYTICS_FILE.exists()
        end_size = ANALYTICS_FILE.stat().st_size
        assert end_size > start_size, "Log file did not grow"
    
        # Read new lines
        with open(ANALYTICS_FILE, 'r', encoding='utf-8') as f:
            f.seek(start_size)
            new_content = f.read()
    
        print("NEW LOGS:\n", new_content)
    
        assert "reference_edited" in new_content
        assert "Original Title" in new_content # Old state
        assert "Edited Title" in new_content # New state
    
>       assert "compliance_report_generated" in new_content
E       assert 'compliance_report_generated' in '{"timestamp": "2026-02-02T13:27:12.613672Z", "event_type": "reference_edited", "data": {"reference_id": "0", "changes...ted Title", "journal": "", "publisher": "Pub", "location": "", "volume": "", "issue": "", "pages": "", "doi": ""}}}}\n'

tests\test_analytics_logging.py:72: AssertionError
---------------------------- Captured stdout call -----------------------------
Log file: C:\Users\stenf\.cache\referencing\analytics_events.jsonl
NEW LOGS:
 {"timestamp": "2026-02-02T13:27:12.613672Z", "event_type": "reference_edited", "data": {"reference_id": "0", "changes": {"old": {"authors": ["Author, A."], "location": "Loc", "pub_type": "book", "publisher": "Pub", "source": "manual", "title": "Original Title", "year": "2023"}, "new": {"source": "manual", "pub_type": "book", "authors": ["Author, A."], "year": "2023", "title": "Edited Title", "journal": "", "publisher": "Pub", "location": "", "volume": "", "issue": "", "pages": "", "doi": ""}}}}

---------------------------- Captured stderr call -----------------------------
2026-02-02 13:27:12,634 - src.analytics - ERROR - Failed to extract compliance stats: 'dict' object has no attribute 'counts'
------------------------------ Captured log call ------------------------------
ERROR    src.analytics:analytics.py:57 Failed to extract compliance stats: 'dict' object has no attribute 'counts'
============================== warnings summary ===============================
..\..\anaconda3\Lib\site-packages\flask_limiter\_extension.py:364
  C:\Users\stenf\anaconda3\Lib\site-packages\flask_limiter\_extension.py:364: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
    warnings.warn(

tests/test_analytics_logging.py::TestAnalyticsLogging::test_log_edit_and_compliace
  C:\Users\stenf\Documents\referencing_backup\src\analytics.py:21: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat() + "Z",

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_analytics_logging.py::TestAnalyticsLogging::test_log_edit_and_compliace
======================== 1 failed, 2 warnings in 1.52s ========================
